name: "(RHIZA) VALIDATE AGENTIC WORKFLOWS"

permissions:
  contents: read

on:
  pull_request:
    paths:
      - ".github/workflows/*.md"
  push:
    branches: [main]
    paths:
      - ".github/workflows/*.md"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install gh-aw extension
        id: install-gh-aw
        continue-on-error: true
        run: |
          if output=$(gh extension install github/gh-aw 2>&1); then
            echo "available=true" >> "$GITHUB_OUTPUT"
          elif echo "$output" | grep -q "HTTP 403\|not found"; then
            echo "gh-aw extension not available (expected for public repos)"
            echo "available=false" >> "$GITHUB_OUTPUT"
          else
            echo "Failed to install gh-aw: $output"
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate lock files are up-to-date
        if: steps.install-gh-aw.outputs.available == 'true'
        run: |
          gh aw compile
          if ! git diff --quiet .github/workflows/*.lock.yml; then
            echo "::error::Agentic workflow lock files are out of date. Run 'gh aw compile' and commit the changes."
            git diff .github/workflows/*.lock.yml
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip validation (gh-aw not available)
        if: steps.install-gh-aw.outputs.available != 'true'
        run: |
          echo "::notice::Skipping validation - gh-aw extension not available. This is expected until gh-aw is publicly released."
