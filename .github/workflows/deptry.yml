# This file is part of the tschm/.config-templates repository
# (https://github.com/tschm/.config-templates).
#
# Workflow: Deptry
# Purpose: This workflow identifies missing and obsolete dependencies in the project.
#          It helps maintain a clean dependency tree by detecting unused packages and
#          implicit dependencies that should be explicitly declared.
name: "DEPTRY"

# Trigger: This workflow runs on every push and on pull requests to the main branch
on:
  push:
  pull_request:
    # Only run on pull requests targeting the main branch
    branches: [ main ]

# Permissions: Only read access to repository contents is needed
permissions:
    contents: read

jobs:
  deptry_analysis:
    name: Check dependencies with deptry
    runs-on: ubuntu-latest

    # Use astral's uv container
    container:
      image: ghcr.io/astral-uv/uv:3.12
      # Make sure we have all the tools needed for CI
      options: --user root

    steps:
      - uses: actions/checkout@v5

      # Run the setup script
      - name: Setup the project
        shell: bash
        run: |
          ./.github/scripts/setup_project.sh
          echo "PYPROJECT_EXISTS=$PYPROJECT_EXISTS" >> $GITHUB_ENV

      - name: Run deptry
        if: env.PYPROJECT_EXISTS == 'true'
        run: task quality:deptry
